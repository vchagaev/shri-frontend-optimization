# Анализ проблем загрузки lifehacker.ru

## Проблемы

* Страница загружается очень медленно через хорошее интернет соединение, а через мобильную сеть (3g regular) кажется, что почти бесконечно. При хорошем 3g страница грузилась примерно 1.5 минуты. А при 100мб wifi 5Ghz около 10 секунд.
* Видно как прыгает контент (ресайзы) при загрузке. Смотрел на скриншоты таймлайна при загрузке для размеров iPad и 3g regular. При таком интернет соединении страничку практически невозможно загрузить.
Для анализа использовал pagescpeed и yslow. Отчет по ним приложил к письму.  К pgu.mos.ru сервисы достучаться не могут почемуто и поэтому я использовал YSlow плагин и Audit Chrome Dev Tools. Проблемы которые есть на  pgu.mos.ru похожи на проблемы lifehacker.ru поэтому сильно расписывать их не стал.
## Причины проблем

#### Много запросов (400+ запросов)

* Большое количество внешних js и css.
* Много запросов к vk, fb и другим социалкам.
* Большое количество редиректов.
* Слишком много dns лукапов
* Скачивание большого количества контента с одного домена
* Как мне кажется слишком большое разнообразие шрифтов используется на странице

#### Большой размер страницы (20+мб)

* Слишком большие изображения (больше чем нужны для отображения)
* Не минифицированные html, css, js
* Не используется gzip и пр. сжатие
* Короткий срок кэша или вообще не кэширование на клиенте
* Использование query strings (?) в URL ресурсов, что может привести к не кэширванию на некоторых прокси серверах.
* Не указан заголовок Vary: Accept-Encoding
* Использование доменов с куки для статики
* 88% css правил не используется на странице
* Большие куки

#### Не учитываются особенности рендеринга страницы

* Не указаны размеры (высота/ширина) у изображений, что приводит к ненужным рефлоу и репаинт
* Парсинг js при загрузке страницы. Не используется в асинхронном режиме то что может быть использовано.
* Не оптимальный порядок стилей и скриптов (сначала стили, а только потом скрипты)
* Очень долгий рендер страницы и постояный пересчет стилей
* Цикличные аппенды в документ

#### Большая страница (~2000 dom-элементов)

## Рекомендации

#### Уменьшение количества запросов

* Самое основное это подумать над количеством контента главной страницы. Нужно ли пользователю сразу загружать столько новостей? Может быть стоит подумать над «бесконечным скролом»? Так же стоит рассмотреть разные шаблоны для разного вида устройств: смартфон, планшет, монитор.
* Изменить работу лайков, просмотров и комментариев. Может быть лучше будет кэшировать данные на сервере, а не тянуть через API соц. Сетей. При это загружая огромное количество внешних скриптов и делая огромное количество запросов. На каждый запрос тратится дополнительное время, а при 3G подключении это намного критичнее. Плюс к этому пункту - проинспектировать верстку т.к. в ней много элементов, которые не видны пользователю.
* Склеить стили и скрипты, чтобы уменьшить количество запросов. Удобно для этого использовать сборку (в gulp gulp-concat). Например можно разбить js на модули и сделать их загрузку асинхронной. Использовать для этого можно например webpack с AMD модулями. Стили можно так же склеить. Так же можно некоторые скрипты и стили просто заинлайнить.
* Стоит подумать над распределением всех ресурсов по четырем доменам, чтобы сократить количество DNS-lookup’ов. Желательно распределить количество ресурсов между ними равномерно, т.к. количество параллельных скачиваний у браузера с одного домена ограничено. Так же стоить использовать CDN.
* Можно рассмотреть создание спрайтов для некоторых изображений.
* Уменьшить количество шрифтов (сейчас их 8) и стратегию отрисовки шрифтов. Я думаю, что заголовки должны появляться раньше тела новости а желательно вообще одновременнов. Опять же на таймлайне скриншотов это можно увидеть.

#### Уменьшение размера страницы

* Оптимизировать размеры и качество изображений. Вообще оправданы ли гифки по 3+ мб? Стоит использовать адаптивные техники для изображений: в зависимости от плотности пикселей пользователя можно выдавать картинки разного качества, в зависимости от размера изображений можно выдавать разные размеры картинок. Рассмотреть использование <picture> и <img srcset>. Для сборки могут быть интересны такие модули как gulp-responsive-images, gulp-image-optimization.
* Использовать gzip для тех ресурсов для которых это оправдано
* Минифицировать html, css, js.
* Кэшировать данные используя заголовки ответа сервера или используя ServiceWorker, который позволяет не только гибко работать с кэшем, но и поможет с оффлайн работой приложения.
* Уменьшить размер куки + для статики стоит использовать cookie free домены.
* Использовать css опитимазторы и вообще продумать работу с css, т.к. 88% не использования css правил это много.

#### Оптимизация рендеринга страницы

* В head сначала дать все ссылки на стили, а желательно чтобы это был один файл или несколько но с media запросом и только после стилей добавлять скрипты (которые необходимо загрузить именно в head), причем важно те скрипты которые можно сделать async/defer сделать именно таковыми. Остальные скрипты поместить в низ старинцы.
* Указать у всех изображений height или weight.
* Аппенд реализовывать сразу кучей, а не по одному элементу.

# Анализ проблем загрузки pgu.mos.ru

## Проблемы

* Полностью страница загружается при 100мб wifi 5G 4+ секунды, а при 3G соединении 20+ секунд.
* Контент скачет. Например хочешь нажать кнопку войти и уже навел на нее курсор, а потом сверху прилетает главное меню и тебе снова приходится целиться на эту кнопку. При самом первом заходе на страницу они конечно сделали очень хитро, всплывающее окно на весь экран, которое скрывает все что происходит со страницей.

## Причины проблем

#### Много запросов (225 запросов)

* Склеить стили, скрипты, по возможности избегать iframe’ов.
* Распараллелить запросы между несколькими хостнеймами
* Уменьшить количество DNS лукапов

#### Выбрана плохая стратегия загрузки страницы (с использование iframe)

* Понятно, что пользователь пришел за услугами и вы стараетесь показать их сначала, но когда шапка сдвигающая весь контент то это слишком. Поэтому лучше продумать стратегию загрузки без использования iframe. Например с использование разных приоритетов для js и css (ниже).
* Разделить js, css на критический и не критический. Критический css подключать сразу как можно раньше в head, не критический css с использование media=’none’ а потом заменять на all. Критический js подключать в head, а не критический подключать внизу страницы причем лучше использовать async/defer.

#### Не использованы все возможности по оптимизации размера ресурвосов

* Использовать для статитки cookie less домены
* Использовать шрифт, а не картинки (нарпимер https://pgu.mos.ru/common/img/elem/banner-auto.png)
* Подтюнить кэш, а может и управлять им при помощи ServiceWorker’a. В частности не все изображения кэшируются + не кэшируются header и footer.
* Использовать сжатие, например gzip
* Минифицировать js, css, html
* Использовать media для ненужных css (90% css правил не используется на главной странице)

